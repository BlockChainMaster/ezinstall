#!/usr/bin/env bash

######################################################################
# Torch install
#
# This script installs Torch7, and a few extra packages
# (penlight, optim, parallel, image).
# 
# The install is done via Luarocks, which enables package
# versions. This is the recommended method to deploy Torch,
# torch-pkg is being deprecated.
#
#    Once this script has been run once, you should be able to run
#    extra torch-rocks commands, and in particular install new packages:
#    $ torch-rocks install json
#    $ torch
#    > require 'json'
#
######################################################################

# Based on Platform:
if [[ `uname` == 'Darwin' ]]; then
    # GCC?
    if [[ `which gcc` == '' ]]; then
        echo "MacOS doesn't come with GCC: please install XCode and the command line tools."
        exit
    fi

    # Install Homebrew (pkg manager):
    if [[ `which brew` == '' ]]; then
        ruby <(curl -fsSkL raw.github.com/mxcl/homebrew/go)
    fi

    # Install dependencies:
    brew install git readline cmake wget qt
    brew install libjpeg imagemagick zeromq 
    brew install lua
    brew link readline --force

elif [[ `uname` == 'Linux' ]]; then
    # Aptitude?
    if [[ `which apt-get` == '' ]]; then
        echo '==> apt-get not found, platform not supported'
        exit
    fi

    # Install dependencies for Torch:
    sudo apt-get install -y python-software-properties
    sudo add-apt-repository ppa:chris-lea/zeromq
    sudo add-apt-repository ppa:chris-lea/node.js
    sudo apt-get update
    sudo apt-get install -y build-essential
    sudo apt-get install -y gcc g++
    sudo apt-get install -y cmake
    sudo apt-get install -y libreadline-dev
    sudo apt-get install -y git-core
    sudo apt-get install -y libqt4-core libqt4-gui libqt4-dev
    sudo apt-get install -y libjpeg-dev
    sudo apt-get install -y libpng-dev
    sudo apt-get install -y ncurses-dev
    sudo apt-get install -y imagemagick
    sudo apt-get install -y libzmq-dev
    sudo apt-get install -y gfortran
    sudo apt-get install -y unzip
    sudo add-apt-repository ppa:chris-lea/zeromq
    sudo apt-get update

    # Get and build OpenBlas (Torch is much better with a decent Blas)
    cd /tmp/
    git clone git://github.com/xianyi/OpenBLAS.git
    cd OpenBLAS
    make NO_AFFINITY=1 USE_OPENMP=1
    sudo make install
    export CMAKE_LIBRARY_PATH=/usr/lib/gcc/x86_64-linux-gnu:/usr/lib/gcc/x86_64-linux-gnu/4.6

else
    # Unsupported
    echo '==> platform not supported, aborting'
    exit
fi

# Build Torch7
cd /tmp
git clone https://github.com/andresy/torch
cd torch
mkdir build; cd build
cmake .. -DWITH_ROCKS=1
make

# Install Torch7 plus other basic packages
if [[ `uname` == 'Darwin' ]]; then
    make install
    torch-rocks install penlight
    torch-rocks install image
    torch-rocks install parallel
    torch-rocks install optim
    torch-rocks install json
elif [[ `uname` == 'Linux' ]]; then
    sudo make install
    sudo -E torch-rocks install penlight
    sudo -E torch-rocks install image
    sudo -E torch-rocks install parallel
    sudo -E torch-rocks install optim
    sudo -E torch-rocks install json
fi

# Done.
echo "==> Torch7 has been installed successfully"
echo "  + Extra packages [penlight, image, parallel, optim, json] have been installed as well:"
echo "     $ torch-rocks list"
echo ""
echo "  + To install more packages, do:"
echo "     $ torch-rocks search --all"
echo "     $ torch-rocks install PKG_NAME"
echo ""
echo "  + Note: on MacOS, it's a good idea to install GCC 4.6 to enable OpenMP."
echo "          You can do this by installing the GFortran bundles provided here:"
echo "          http://gcc.gnu.org/wiki/GFortranBinaries"

